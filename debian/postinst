#!/bin/bash
# postinst script for geonode
#
# see: dh_installdeb(1)

set -e

# summary of how this script can be called:
#	* <postinst> `configure' <most-recently-configured-version>
#	* <old-postinst> `abort-upgrade' <new version>
#	* <conflictor's-postinst> `abort-remove' `in-favour' <package>
#	  <new-version>
#	* <postinst> `abort-remove'
#	* <deconfigured's-postinst> `abort-deconfigure' `in-favour'
#	  <failed-install-package> <version> `removing'
#	  <conflicting-package> <version>
# for details, see http://www.debian.org/doc/debian-policy/ or
# the debian-policy package

function randpass() {
  [ "$2" == "0" ] && CHAR="[:alnum:]" || CHAR="[:graph:]"
    cat /dev/urandom | tr -cd "$CHAR" | head -c ${1:-32}
    echo
}

function configuretomcat() {

	# configure tomcat
	# FIXME(Ariel): Make this a patch
	cat <<- EOF >> /etc/default/tomcat6
	JAVA_OPTS="-Djava.awt.headless=true -Xmx1024m -Xms1024M -XX:MaxPermSize=256m -XX:CompileCommand=exclude,net/sf/saxon/event/ReceivingContentHandler.startElement"
	EOF
	# perform geonode specific customizations on geoserver
	#
	patch -l /var/lib/tomcat6/webapps/geoserver/WEB-INF/web.xml  < /usr/share/geonode/patch.geoserver
        sed -i "s/THE_GEONODE_BASE_URL/$myhost/g" /var/lib/tomcat6/webapps/geoserver/WEB-INF/web.xml
	patch -R -l /var/lib/tomcat6/webapps/geonetwork/WEB-INF/config.xml  < /usr/share/geonode/patch.geonetwork
        sed -i "s/GEONODE_DATABASE_PASSWORD/$psqlpass/g" /var/lib/tomcat6/webapps/geonetwork/WEB-INF/config.xml
        sed -i "s/jdbc:postgresql:geonetwork/jdbc:postgresql:geonode/g" /var/lib/tomcat6/webapps/geonetwork/WEB-INF/config.xml

        # and set the tomcat user as the owner
        chown tomcat6. /var/lib/geoserver/data/ -R
        chown tomcat6. /var/lib/tomcat6/webapps/geonetwork -R
        chown tomcat6. /var/lib/tomcat6/webapps/geoserver -R

	invoke-rc.d tomcat6 restart
}

function configurepostgres() {
	# configure postgres user and database
	#
        if su - postgres -c 'psql -l | grep -q template_postgis'
        then
	    echo
	else
	    su - postgres /usr/share/geonode/create_template_postgis-debian.sh
	fi

	psqlpass=$(randpass 8 0)
        if su - postgres -c 'psql -l | grep -q geonode'
	then
	    echo 'Not creating geonode database because it already exists'
	    echo "ALTER ROLE geonode with password '$psqlpass';" > /usr/share/geonode/role.sql
	else
	    su - postgres -c "createdb geonode -T template_postgis"
	    echo "CREATE ROLE geonode with login password '$psqlpass' SUPERUSER INHERIT;" > /usr/share/geonode/role.sql
	fi
	su - postgres -c "psql < /usr/share/geonode/role.sql"

}

function configuredjango() {
	# set up django
	#
	cd /var/lib/geonode
	python bootstrap.py

        mv src/GeoNodePy/geonode/media/static src/GeoNodePy/geonode/media/geonode

	# FIXME(Ariel): Put geoserverpass and secretkey in local_settings
        secretkey=$(randpass 18 0)
        geoserverpass=$(randpass 8 0)

        sed -i "s/THE_SECRET_KEY/$secretkey/g" /etc/default/geonode
        sed -i "s/THE_GEOSERVER_PASSWORD/$geoserverpass/g" /etc/default/geonode
        sed -i "s/THE_DATABASE_PASSWORD/$psqlpass/g" /etc/default/geonode
	ln -s /etc/default/geonode /var/lib/geonode/src/GeoNodePy/geonode/local_settings.py
	chmod +x /usr/bin/geonode
	/usr/bin/geonode syncdb --noinput
	/usr/bin/geonode collectstatic -v0 --noinput
	/usr/bin/geonode loaddata /usr/share/geonode/admin.json
}

function configureapache() {
	# Setup apache
	#
	chown www-data -R /var/www/geonode/
	a2dissite default
	a2enmod proxy_http
	sitedir=`/var/lib/geonode/bin/python -c "from distutils.sysconfig import get_python_lib; print get_python_lib()"`
        
	sed -i '1d' /etc/apache2/sites-available/geonode
	sed -i "1i WSGIDaemonProcess geonode user=www-data threads=15 processes=2 python-path=$sitedir" /etc/apache2/sites-available/geonode

	a2ensite geonode
	invoke-rc.d apache2 restart
}
case "$1" in
    configure)

	configurepostgres
	configuretomcat
	configuredjango
	configureapache
    ;;

    abort-upgrade|abort-remove|abort-deconfigure)
    ;;

    *)
	echo "postinst called with unknown argument \`$1'" >&2
	exit 1
    ;;
esac

# dh_installdeb will replace this with shell code automatically
# generated by other debhelper scripts.

#DEBHELPER#

db_stop;

exit 0
